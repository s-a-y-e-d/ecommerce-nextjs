'use client'

import dayjs from 'dayjs';
import formateMoney from '../../lib/utiles/money';
import { CartItem, DeliveryOption } from '../generated/prisma';
import { selectDeliveryOption } from '../../lib/utiles/actions';
import { useOptimistic, useTransition } from 'react';

type Props = {
  cartItem: CartItem,
  deliveryOption: DeliveryOption,
}

export default function DeliveryOptionCard({ deliveryOption, cartItem }: Props) {
  const [selectedId, setSelectedId] = useOptimistic<number, number>(cartItem.deliveryOptionId, (_, newId) => newId);

  const [isPending, startTransition] = useTransition();

  const handleClick = () => {
    // Move the optimistic update into a transition so React doesn't warn.
    startTransition(() => {
      // âœ… Update UI instantly (optimistic)
      setSelectedId(deliveryOption.id);

      // ðŸ§  Run server action in background
      // call without awaiting here to keep the transition callback sync-like
      void selectDeliveryOption(cartItem, deliveryOption.id);
    });
  };

  let priceString = 'FREE Shipping';
  if (deliveryOption.priceCents > 0) {
    priceString = `$${formateMoney(deliveryOption.priceCents)} - Shipping`;
  }

  return (

    <div
      className={`delivery-option ${isPending ? 'opacity-50' : ''}`}
      onClick={handleClick}
    >
      <input
        id={`delivery-option-${deliveryOption.id}`}
        type="radio"
        checked={deliveryOption.id === selectedId}
        onChange={handleClick}
        className="delivery-option-input"
        name={`delivery-option-${cartItem.productId}`}
        value={deliveryOption.id}
      />
      <div>
        <div className="delivery-option-date">
          {dayjs().add(deliveryOption.deliveryDays, 'day').format('dddd, MMMM D')}
        </div>
        <div className="delivery-option-price">{priceString}</div>
      </div>
    </div>
  );
}
